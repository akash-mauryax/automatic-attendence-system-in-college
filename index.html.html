<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>e-Hazri</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Importing face-api.js -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
     
     <style>
        /* General Body Styles */
body {
    font-family: 'Roboto', sans-serif;
    background-image: url('https://images.unsplash.com/photo-1579546929518-9e396f3cc809?q=80&w=2070&auto=format&fit=crop');
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
    margin: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    padding: 20px;
    box-sizing: border-box; /* Ensures padding doesn't affect total width/height */
}

.container {
    width: 95%;
    max-width: 1400px;
    background-color: rgba(255, 255, 255, 0.5); /* Semi-transparent background */
    backdrop-filter: blur(10px); /* Blurry effect */
    -webkit-backdrop-filter: blur(10px); /* For Safari */
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.18);
    overflow: hidden;
    padding: 20px;
    position: relative;
}

/* Header Styles */
.header {
    display: flex;
    align-items: center;
    padding-bottom: 20px;
    margin-bottom: 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

#menu-toggle-btn {
    width: 32px;
    height: 32px;
    color: #333;
    cursor: pointer;
    margin-right: 15px;
    transition: color 0.3s ease;
}
#menu-toggle-btn:hover {
    color: #00A99D;
}

.header-icon {
    width: 32px;
    height: 32px;
    color: #00A99D;
    margin-right: 12px;
}

.header-title {
    font-size: 2em;
    font-weight: 700;
    color: #333;
    margin: 0;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
}

/* Main Layout */
.main-layout {
    display: flex;
    gap: 20px;
    transition: gap 0.4s ease;
}

.menu-bar {
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    width: 220px;
    border: 1px solid rgba(255, 255, 255, 0.18);
    border-radius: 8px;
    overflow: hidden;
    background-color: rgba(255, 255, 255, 0.2);
    transition: margin-left 0.4s ease;
    margin-left: 0;
}

.main-layout.sidebar-collapsed .menu-bar {
    margin-left: -240px; /* width (220) + gap (20) */
}
.main-layout.sidebar-collapsed {
    gap: 0;
}

.menu-item {
    padding: 15px;
    text-align: left;
    cursor: pointer;
    color: #333;
    border-bottom: 1px solid rgba(255, 255, 255, 0.18);
    transition: background-color 0.3s ease;
}
.menu-item:last-child {
    border-bottom: none;
}
.menu-item:hover {
    background-color: rgba(255, 255, 255, 0.4);
}
.menu-item.active {
    background-color: #00A99D;
    color: #fff;
    font-weight: bold;
}

.content-box {
    flex-grow: 1;
    border: 1px solid rgba(255, 255, 255, 0.18);
    border-radius: 8px;
    min-height: 500px;
    padding: 20px;
    background-color: rgba(255, 255, 255, 0.3);
}
.content-box h3, .content-box h4 {
    margin-top: 0;
    color: #333;
    text-align: center; /* Center main headings */
}

/* Forms and Buttons */
.sub-menu, .attendance-options {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
}

.attendance-type-selector {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 20px;
}

.attendance-type-selector label {
    font-size: 1.1em;
    font-weight: 500;
    color: #333;
}

.camera-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
}

.camera-container video, .camera-container canvas {
    max-width: 100%;
    width: 400px;
    border: 2px solid rgba(51, 51, 51, 0.4);
    border-radius: 8px;
}

#capture-message {
    font-weight: 500;
    color: #333;
}

.form-button, .camera-button, .sub-option, .edit-btn, .delete-btn, .modal-ok-btn, .modal-cancel-btn {
    padding: 10px 18px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-weight: 500;
    color: #fff;
    transition: background-color 0.2s;
}

.sub-option {
    background-color: #17a2b8;
}

.form-button, .camera-button {
    background-color: #28a745;
}
.form-button:hover, .camera-button:hover {
    background-color: #218838;
}

.delete-btn {
    background-color: #dc3545;
}
.delete-btn:hover {
    background-color: #b02a37;
}

.edit-btn {
    background-color: #ffc107;
    color: #212529;
}
.edit-btn:hover {
    background-color: #d39e00;
}

.back-button {
    background-color: #6c757d;
    width: fit-content;
    margin-bottom: 20px;
}
.back-button:hover {
    background-color: #5a6268;
}

.form-container {
    margin-top: 20px;
}

.form-container label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #333;
}

input[type="text"], input[type="email"], input[type="password"], input[type="date"] {
    display: block;
    width: 95%;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 4px;
    border: 1px solid #ccc;
    background-color: rgba(255, 255, 255, 0.7);
    color: #333;
}

.form-grid {
    display: flex;
    gap: 25px;
    align-items: flex-start;
}

.form-fields {
    flex: 1;
}

.form-image-preview {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    margin: 0 auto 20px auto;
    border: 3px solid rgba(255, 255, 255, 0.8);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
    display: none; /* Hidden by default, shown by JS */
}

.camera-section {
    flex: 1.5;
    display: flex;
    flex-direction: column;
    align-items: stretch;
    gap: 15px;
    padding: 15px;
    background-color: rgba(255, 255, 255, 0.2);
    border-radius: 8px;
}

.video-capture-wrapper {
    flex-grow: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(0,0,0,0.1);
    border-radius: 8px;
    overflow: hidden;
    min-height: 250px;
}

.video-capture-wrapper video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: none; /* Hidden by default, shown by JS */
}

/* Table Styles */
.available-list table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    background-color: rgba(255, 255, 255, 0.7);
}
.available-list th, .available-list td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    color: #333;
}
.available-list th {
    background-color: rgba(0, 169, 157, 0.2);
}
.available-list img {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border-radius: 50%;
}
.action-buttons {
    display: flex;
    gap: 10px;
}

/* Loading Overlay */
#loading-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(5px);
    display: none; /* Hidden by default, shown by JS */
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}
.loader {
    border: 8px solid #f3f3f3;
    border-top: 8px solid #00A99D;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
#loading-message {
    margin-top: 20px;
    color: #333;
    font-size: 1.2em;
    font-weight: 500;
}

/* Modal */
.modal-backdrop {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(5px);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 200;
}
.modal-backdrop.visible {
    display: flex;
}
.modal-content {
    background: white;
    padding: 25px;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    min-width: 300px;
    max-width: 90%;
    color: #333;
}
.modal-buttons {
    margin-top: 20px;
    display: flex;
    justify-content: center;
    gap: 15px;
}
.modal-ok-btn {
    background-color: #00A99D;
}
.modal-cancel-btn {
    background-color: #6c757d;
}

#logout-btn {
    display: none;
    margin-left: auto;
    background-color: #dc3545;
}

/* Canvas elements used for processing should be off-screen */
#photo-canvas,
#student-canvas,
#faculty-canvas,
#administrator-canvas {
    position: absolute;
    left: -9999px;
}

/* Attendance Status */
.status-toggle {
    padding: 6px 12px;
    border-radius: 15px;
    color: white;
    border: none;
    cursor: pointer;
    min-width: 80px;
    text-align: center;
}
.status-toggle.present {
    background-color: #28a745;
}
.status-toggle.absent {
    background-color: #dc3545;
}
.loader-small {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(0, 0, 0, 0.2);
    border-radius: 50%;
    border-top-color: #333;
    animation: spin 1s ease-in-out infinite;
}
     </style>

</head>
<body>

<div class="container">
    <!-- Loading overlay for face-api models -->
    <div id="loading-overlay">
        <div class="loader"></div>
        <div id="loading-message">Loading Facial Recognition Models...</div>
    </div>

    <!-- Custom Modal Structure -->
    <div id="custom-modal" class="modal-backdrop">
        <div class="modal-content">
            <p id="modal-message"></p>
            <input type="password" id="modal-password" placeholder="Enter your password">
            <div class="modal-buttons">
                <button id="modal-ok-btn" class="modal-ok-btn">OK</button>
                <button id="modal-cancel-btn" class="modal-cancel-btn">Cancel</button>
            </div>
        </div>
    </div>
    
    <div class="header">
        <svg id="menu-toggle-btn" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        <svg class="header-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="m9 16 2 2 4-4"/></svg>
        <h1 class="header-title">e-Hazri</h1>
        <button id="logout-btn" class="form-button" style="display:none; margin-left: auto; background-color: #dc3545;">Logout</button>
    </div>

    <div class="main-layout sidebar-collapsed">
        <div class="menu-bar">
            <div class="menu-item active" data-content-id="face-attendance">Face Attendance</div>
            <div class="menu-item" data-content-id="student-data">Student Data</div>
            <div class="menu-item" data-content-id="student-attendance">Student Attendance</div>
            <div class="menu-item" data-content-id="faculty-data">Faculty Data</div>
            <div class="menu-item" data-content-id="faculty-attendance">Faculty Attendance</div>
            <div class="menu-item" data-content-id="administrator">Administrator</div>
        </div>

        <div class="content-box" id="content-display">
            <!-- Content will be dynamically injected here by script.js -->
        </div>
    </div>
</div>

<!-- Firebase and App Logic -->
<script  type="module">
    // Import the functions you need from the SDKs you need
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
    getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, setDoc, onSnapshot, query, where, getDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import {
    getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously,
    reauthenticateWithCredential, EmailAuthProvider
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

// Your web app's Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyAanVVFv6kudYI5dQ9jVxDJ-iAONSSyHdU",
    authDomain: "e-hazri.firebaseapp.com",
    projectId: "e-hazri",
    storageBucket: "e-hazri.appspot.com",
    messagingSenderId: "728924213243",
    appId: "1:728924213243:web:e2449e26d5cae1f2c6055e",
    measurementId: "G-6X6EZSBRXW"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app)
const auth = getAuth(app);

// Global listeners for real-time data
let studentsUnsubscribe = null;
let facultiesUnsubscribe = null;
let administratorsUnsubscribe = null;
let studentsCache = [];
let facultiesCache = [];
let administratorsCache = [];
let initialAuthChecked = false; // Flag to handle initial load

document.addEventListener('DOMContentLoaded', () => {
    const menuItems = document.querySelectorAll('.menu-item');
    const contentBox = document.getElementById('content-display');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingMessage = document.getElementById('loading-message');
    const logoutBtn = document.getElementById('logout-btn');
    const menuToggleBtn = document.getElementById('menu-toggle-btn');
    const mainLayout = document.querySelector('.main-layout');

    if (menuToggleBtn && mainLayout) {
        menuToggleBtn.addEventListener('click', () => {
            mainLayout.classList.toggle('sidebar-collapsed');
        });
    }

    let currentStream = null;
    let editingId = null; 
    let editingType = '';

    // --- Custom Modal Logic ---
    const customModal = document.getElementById('custom-modal');
    const modalMessage = document.getElementById('modal-message');
    const modalOkBtn = document.getElementById('modal-ok-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    const modalPasswordInput = document.getElementById('modal-password');


    function showAlert(message) {
        return new Promise((resolve) => {
            modalMessage.textContent = message;
            modalPasswordInput.style.display = 'none';
            modalCancelBtn.style.display = 'none';
            modalOkBtn.style.display = 'inline-block';
            customModal.classList.add('visible');
            modalOkBtn.onclick = () => {
                customModal.classList.remove('visible');
                resolve(true);
            };
        });
    }

    function showConfirm(message) {
        return new Promise((resolve) => {
            modalMessage.textContent = message;
            modalPasswordInput.style.display = 'none';
            modalCancelBtn.style.display = 'inline-block';
            modalOkBtn.style.display = 'inline-block';
            customModal.classList.add('visible');
            modalOkBtn.onclick = () => {
                customModal.classList.remove('visible');
                resolve(true);
            };
            modalCancelBtn.onclick = () => {
                customModal.classList.remove('visible');
                resolve(false);
            };
        });
    }

    function showPasswordConfirm(message) {
        return new Promise((resolve) => {
            modalMessage.textContent = message;
            modalPasswordInput.value = '';
            modalPasswordInput.style.display = 'block';
            modalCancelBtn.style.display = 'inline-block';
            modalOkBtn.style.display = 'inline-block';
            customModal.classList.add('visible');
            
            modalOkBtn.onclick = () => {
                customModal.classList.remove('visible');
                modalPasswordInput.style.display = 'none';
                resolve(modalPasswordInput.value); // Resolve with the password
            };
            
            modalCancelBtn.onclick = () => {
                customModal.classList.remove('visible');
                modalPasswordInput.style.display = 'none';
                resolve(null); // Resolve with null if cancelled
            };
        });
    }

    // --- Face-API Model Loading ---
    async function loadFaceApiModels() {
        const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
        try {
            loadingMessage.textContent = 'Loading Core Model...';
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            loadingMessage.textContent = 'Loading Landmarks Model...';
            await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
            loadingMessage.textContent = 'Loading Recognition Model...';
            await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
            loadingOverlay.style.display = 'none';
        } catch (error) {
            loadingMessage.textContent = 'Failed to load models. Please refresh.';
            console.error('Model loading failed:', error);
        }
    }
    loadFaceApiModels();


    // --- Firestore Data Fetching ---
    function listenToStudents() {
        if (studentsUnsubscribe) studentsUnsubscribe();
        studentsUnsubscribe = onSnapshot(collection(db, "students"), (snapshot) => {
            studentsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (document.getElementById('studentList')) renderStudents();
        });
    }

    function listenToFaculties() {
        if (facultiesUnsubscribe) facultiesUnsubscribe();
        facultiesUnsubscribe = onSnapshot(collection(db, "faculties"), (snapshot) => {
            facultiesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (document.getElementById('facultyList')) renderFaculties();
        });
    }

    function listenToAdministrators() {
        if (administratorsUnsubscribe) administratorsUnsubscribe();
        administratorsUnsubscribe = onSnapshot(collection(db, "administrators"), (snapshot) => {
            administratorsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (document.getElementById('administratorList')) renderAdministrators();
        });
    }
    
    // --- ATTENDANCE PERCENTAGE CALCULATION ---
async function calculateAttendancePercentage(personId, type) {
    const collectionName = `${type}_attendance`;
    const q = collection(db, collectionName);
    try {
        const querySnapshot = await getDocs(q);
        // CHANGE 1: Total days is the total number of attendance documents (days class was held)
        const totalDays = querySnapshot.size;
        let presentDays = 0;

        if (totalDays === 0) {
            return 'N/A';
        }

        // CHANGE 2: The loop now only needs to count the days a student was present
        querySnapshot.forEach(doc => {
            const records = doc.data().records;
            if (records && records.hasOwnProperty(personId) && records[personId] === 'Present') {
                presentDays++;
            }
        });

        const percentage = (presentDays / totalDays) * 100;
        return `${percentage.toFixed(1)}%`;
    } catch (error) {
        console.error(`Error calculating attendance for ${personId}:`, error);
        return 'Error';
    }
}


    const mainContent = {
        'student-data': `
            <h3>Student Data</h3>
            <div class="sub-menu">
                <button class="sub-option" data-sub-content="add-student">Add New Student</button>
            </div>
            <div id="studentList" class="available-list"></div>`,
        'faculty-data': `
            <h3>Faculty Data</h3>
            <div class="sub-menu">
                <button class="sub-option" data-sub-content="add-faculty">Add New Faculty</button>
            </div>
            <div id="facultyList" class="available-list"></div>`,
        'administrator': `
            <h3>Administrator Data</h3>
            <div id="administratorList" class="available-list"></div>
            <hr>
            <h3>Administrator Attendance Dashboard</h3>
            <div class="attendance-options">
                <input type="date" id="administrator-attendance-date">
                <button id="view-administrator-attendance-btn">View Historical</button>
            </div>
             <h4>Mark Today's Attendance:</h4>
            <div class="sub-menu">
                <button class="sub-option" data-sub-content="mark-administrator-attendance-manual">Manually</button>
            </div>
            <div id="administrator-attendance-sheet-container" class="available-list"></div>`,
        'face-attendance': `
            <h3>Face Attendance</h3>
            <div class="attendance-type-selector">
                <label><input type="radio" name="attendanceType" value="student" checked> Student</label>
                <label><input type="radio" name="attendanceType" value="faculty"> Faculty</label>
                <label><input type="radio" name="attendanceType" value="administrator"> Administrator</label>
            </div>
            <div class="camera-container">
                 <video id="video-stream" width="400" height="300" autoplay muted></video>
                 <button id="capture-image" class="camera-button">Capture</button>
                 <canvas id="photo-canvas" width="400" height="300" style="display:none;"></canvas>
                 <div id="capture-message"></div>
            </div>`,
        'student-attendance': `
            <h3>Student Attendance Dashboard</h3>
            <div class="attendance-options">
                <input type="date" id="student-attendance-date">
                <button id="view-student-attendance-btn">View Historical</button>
            </div>
            <h4>Mark Today's Attendance:</h4>
            <div class="sub-menu">
                <button class="sub-option" data-sub-content="mark-student-attendance-manual">Manually</button>
            </div>
            <div id="student-attendance-sheet-container" class="available-list"></div>`,
        'faculty-attendance': `
            <h3>Faculty Attendance Dashboard</h3>
            <div class="attendance-options">
                <input type="date" id="faculty-attendance-date">
                <button id="view-faculty-attendance-btn">View Historical</button>
            </div>
             <h4>Mark Today's Attendance:</h4>
            <div class="sub-menu">
                <button class="sub-option" data-sub-content="mark-faculty-attendance-manual">Manually</button>
            </div>
            <div id="faculty-attendance-sheet-container" class="available-list"></div>`
    };

    const subContent = {
        'mark-student-attendance-manual': `
            <button class="form-button back-button" data-back-to="student-attendance">Back to Dashboard</button>
            <h3>Mark Student Attendance Manually for Today</h3>
            <div id="student-manual-attendance-sheet" class="available-list"></div>
            `,
        'mark-faculty-attendance-manual': `
            <button class="form-button back-button" data-back-to="faculty-attendance">Back to Dashboard</button>
            <h3>Mark Faculty Attendance Manually for Today</h3>
            <div id="faculty-manual-attendance-sheet" class="available-list"></div>
            `,
        'mark-administrator-attendance-manual': `
            <button class="form-button back-button" data-back-to="administrator">Back to Dashboard</button>
            <h3>Mark Administrator Attendance Manually for Today</h3>
            <div id="administrator-manual-attendance-sheet" class="available-list"></div>
            `,
        'add-student': `
            <button class="form-button back-button" data-back-to="student-data">Back</button>
            <h4>Add New Student</h4>
            <form class="form-container" id="add-student-form">
                <div class="form-grid">
                    <div class="form-fields">
                        <img id="studentImagePreview" class="form-image-preview" src="" alt="Image Preview">
                        <label for="studentName">Name:</label><input type="text" id="studentName" required>
                        <label for="studentCollegeId">College ID:</label><input type="text" id="studentCollegeId" required>
                        <label for="studentClass">Class:</label><input type="text" id="studentClass" required>
                        <label for="studentPhone">Phone Number:</label><input type="text" id="studentPhone">
                        <label for="parentPhone">Parents' Phone Number:</label><input type="text" id="parentPhone">
                    </div>
                    <div class="camera-section">
                        <div class="video-capture-wrapper">
                           <video id="student-video" autoplay muted></video>
                           <canvas id="student-canvas" width="400" height="300"></canvas>
                        </div>
                        <button type="button" class="camera-button" id="openCameraBtnStudent">Open Camera</button>
                    </div>
                </div>
                <button type="submit" class="form-button" id="saveStudentBtn" style="margin-top: 15px; width: 100%;">Save Student</button>
            </form>`,
        'add-faculty': `
            <button class="form-button back-button" data-back-to="faculty-data">Back</button>
            <h4>Add New Faculty</h4>
            <form class="form-container" id="add-faculty-form">
                <div class="form-grid">
                    <div class="form-fields">
                        <img id="facultyImagePreview" class="form-image-preview" src="" alt="Image Preview">
                        <label for="facultyName">Faculty Name:</label><input type="text" id="facultyName" required>
                        <label for="facultyDepartment">Department:</label><input type="text" id="facultyDepartment" required>
                        <label for="facultySubject">Subject:</label><input type="text" id="facultySubject" required>
                        <label for="facultyPhone">Phone Number:</label><input type="text" id="facultyPhone">
                    </div>
                    <div class="camera-section">
                        <div class="video-capture-wrapper">
                           <video id="faculty-video" autoplay muted></video>
                           <canvas id="faculty-canvas" width="400" height="300"></canvas>
                        </div>
                        <button type="button" class="camera-button" id="openCameraBtnFaculty">Open Camera</button>
                    </div>
                </div>
                <button type="submit" class="form-button" id="saveFacultyBtn" style="margin-top: 15px; width: 100%;">Save Faculty</button>
            </form>`,
    };

    function stopCamera(streamToStop) {
        if (streamToStop) {
            streamToStop.getTracks().forEach(track => track.stop());
            currentStream = null;
        }
    }
    
    function getFormattedDate(date) {
        return date.toISOString().split('T')[0];
    }
    
    // AUTHENTICATION LOGIC
    onAuthStateChanged(auth, user => {
        if (user && !user.isAnonymous) {
            // User is a logged-in administrator
            logoutBtn.style.display = 'block';
            listenToStudents();
            listenToFaculties();
            listenToAdministrators();
        } else {
            // User is anonymous or logged out
            logoutBtn.style.display = 'none';
            // Stop listening to data to save reads
            if (studentsUnsubscribe) studentsUnsubscribe();
            if (facultiesUnsubscribe) facultiesUnsubscribe();
            if (administratorsUnsubscribe) administratorsUnsubscribe();
            studentsCache = [];
            facultiesCache = [];
            administratorsCache = [];
        }

        // This block runs only ONCE on initial page load after auth state is confirmed
        if (!initialAuthChecked) {
            initialAuthChecked = true;
            const defaultContentId = 'face-attendance';
            // ALWAYS show the face attendance page on initial load, regardless of auth state.
            updateMainContent(defaultContentId);
            
            // Set the active menu item regardless
            document.querySelector(`.menu-item[data-content-id="${defaultContentId}"]`).classList.add('active');
        }
    });

    function renderLogin(targetContentId) {
        contentBox.innerHTML = `
            <h3>Administrator Login</h3>
            <form id="login-form" class="form-container">
                <label for="adminEmailLogin">Email:</label>
                <input type="email" id="adminEmailLogin" required>
                <label for="adminPasswordLogin">Password:</label>
                <input type="password" id="adminPasswordLogin" required>
                <button type="submit" class="form-button" style="width: 100%;">Login</button>
            </form>
            <div style="text-align: center; margin-top: 20px;">
                Don't have an account? <button id="go-to-signup">Sign Up</button>
            </div>
        `;
        document.getElementById('login-form').addEventListener('submit', (e) => {
            handleLogin(e, targetContentId);
        });
        document.getElementById('go-to-signup').addEventListener('click', () => {
            renderSignUp(targetContentId);
        });
    }

    function renderSignUp(targetContentId) {
        contentBox.innerHTML = `
            <button id="back-to-login" class="form-button back-button">Back to Login</button>
            <h4>Administrator Sign Up</h4>
            <form class="form-container" id="admin-signup-form">
                <div class="form-grid">
                    <div class="form-fields">
                        <img id="administratorImagePreview" class="form-image-preview" src="" alt="Image Preview">
                        <label for="administratorName">Name:</label><input type="text" id="administratorName" required>
                        <label for="administratorEmail">Email:</label><input type="email" id="administratorEmail" required>
                        <label for="administratorRole">Role (e.g., Principal):</label><input type="text" id="administratorRole" required>
                        <label for="administratorPhone">Phone Number:</label><input type="text" id="administratorPhone">
                        <label for="administratorPassword">Password:</label><input type="password" id="administratorPassword" required>
                    </div>
                    <div class="camera-section">
                        <div class="video-capture-wrapper">
                           <video id="administrator-video" autoplay muted></video>
                           <canvas id="administrator-canvas" width="400" height="300"></canvas>
                        </div>
                        <button type="button" class="camera-button" id="openCameraBtnAdministrator">Open Camera</button>
                    </div>
                </div>
                <button type="submit" class="form-button" style="margin-top: 15px; width: 100%;">Sign Up</button>
            </form>
        `;
        document.getElementById('back-to-login').addEventListener('click', () => renderLogin(targetContentId));
        setupSignUpFormListeners(targetContentId);
    }

    async function setupSignUpFormListeners(targetContentId) {
        const form = document.getElementById(`admin-signup-form`);
        const imagePreview = document.getElementById(`administratorImagePreview`);
        setupGenericCamera('administrator');

        form.onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('administratorEmail').value;
            const password = document.getElementById('administratorPassword').value;

            const imageUrl = imagePreview.src;
            if (!imageUrl || imageUrl.length < 100) {
                showAlert('Please capture an image before signing up.'); return;
            }

            const detection = await faceapi.detectSingleFace(imagePreview, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
            if (!detection) {
                showAlert('No face detected. Please retake the photo.'); return;
            }
            
            loadingOverlay.style.display = 'flex';
            loadingMessage.textContent = 'Creating account...';

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                const descriptor = Array.from(detection.descriptor);
                const adminData = {
                    uid: user.uid,
                    name: document.getElementById('administratorName').value,
                    email: email,
                    role: document.getElementById('administratorRole').value,
                    phone: document.getElementById('administratorPhone').value,
                    imageUrl, 
                    descriptor
                };
                await addDoc(collection(db, "administrators"), adminData);
                
                loadingOverlay.style.display = 'none';
                await showAlert('Sign up successful! You can now log in.');
                renderLogin(targetContentId);

            } catch (error) {
                loadingOverlay.style.display = 'none';
                showAlert(`Sign up failed: ${error.message}`);
                console.error("Sign up error:", error);
            }
        };
    }

    async function handleLogin(e, targetContentId) {
        e.preventDefault();
        const email = document.getElementById('adminEmailLogin').value;
        const pass = document.getElementById('adminPasswordLogin').value;
        
        loadingOverlay.style.display = 'flex';
        loadingMessage.textContent = 'Logging in...';

        try {
            await signInWithEmailAndPassword(auth, email, pass);
            loadingOverlay.style.display = 'none';
            menuItems.forEach(item => item.classList.toggle('active', item.dataset.contentId === targetContentId));
            updateMainContent(targetContentId);
        } catch (error) {
            loadingOverlay.style.display = 'none';
            showAlert(`Login failed: ${error.message}`);
        }
    }

    logoutBtn.addEventListener('click', async () => {
        await signOut(auth);
        const defaultContentId = 'face-attendance'; 
        menuItems.forEach(item => item.classList.remove('active'));
        const defaultMenuItem = document.querySelector(`.menu-item[data-content-id="${defaultContentId}"]`);
        if (defaultMenuItem) defaultMenuItem.classList.add('active');
        updateMainContent(defaultContentId);
    });

    // --- RENDER LISTS ---
    function renderStudents() {
        const listDiv = document.getElementById('studentList');
        if (!listDiv) return;
        if (studentsCache.length === 0) {
            listDiv.innerHTML = '<p>No students added yet.</p>';
            return;
        }
        const table = `<table><thead><tr><th>S.No</th><th>Image</th><th>Name</th><th>College ID</th><th>Class</th><th>Attendance %</th><th>Actions</th></tr></thead><tbody>
            ${studentsCache.map((s, i) => `<tr>
                <td>${i + 1}</td>
                <td><img src="${s.imageUrl}" alt="Student Image"></td>
                <td>${s.name}</td><td>${s.collegeId}</td><td>${s.studentClass}</td>
                <td data-percentage-id="${s.id}"><span class="loader-small"></span></td>
                <td><div class="action-buttons">
                    <button class="edit-btn" data-type="student" data-id="${s.id}">Edit</button>
                    <button class="delete-btn" data-type="student" data-id="${s.id}">Delete</button>
                </div></td>
            </tr>`).join('')}
        </tbody></table>`;
        listDiv.innerHTML = table;

        studentsCache.forEach(async (student) => {
            const percentage = await calculateAttendancePercentage(student.id, 'student');
            const cell = listDiv.querySelector(`td[data-percentage-id="${student.id}"]`);
            if (cell) {
                cell.textContent = percentage;
            }
        });
    }

    function renderFaculties() {
        const listDiv = document.getElementById('facultyList');
        if (!listDiv) return;
        if (facultiesCache.length === 0) {
            listDiv.innerHTML = '<p>No faculties added yet.</p>';
            return;
        }
        const table = `<table><thead><tr><th>S.No</th><th>Image</th><th>Name</th><th>Department</th><th>Subject</th><th>Attendance %</th><th>Actions</th></tr></thead><tbody>
            ${facultiesCache.map((f, i) => `<tr>
                <td>${i + 1}</td>
                <td><img src="${f.imageUrl}" alt="Faculty Image"></td>
                <td>${f.name}</td><td>${f.department}</td><td>${f.subject}</td>
                <td data-percentage-id="${f.id}"><span class="loader-small"></span></td>
                <td><div class="action-buttons">
                    <button class="edit-btn" data-type="faculty" data-id="${f.id}">Edit</button>
                    <button class="delete-btn" data-type="faculty" data-id="${f.id}">Delete</button>
                </div></td>
            </tr>`).join('')}
        </tbody></table>`;
        listDiv.innerHTML = table;

        facultiesCache.forEach(async (faculty) => {
            const percentage = await calculateAttendancePercentage(faculty.id, 'faculty');
            const cell = listDiv.querySelector(`td[data-percentage-id="${faculty.id}"]`);
            if (cell) {
                cell.textContent = percentage;
            }
        });
    }
    
    function renderAdministrators() {
        const listDiv = document.getElementById('administratorList');
        if (!listDiv) return;
        if (administratorsCache.length === 0) {
            listDiv.innerHTML = '<p>No administrators added yet.</p>';
            return;
        }
        const table = `<table><thead><tr><th>S.No</th><th>Image</th><th>Name</th><th>Email</th><th>Role</th><th>Attendance %</th><th>Actions</th></tr></thead><tbody>
            ${administratorsCache.map((a, i) => `<tr>
                <td>${i + 1}</td>
                <td><img src="${a.imageUrl}" alt="Admin Image"></td>
                <td>${a.name}</td><td>${a.email}</td><td>${a.role}</td>
                <td data-percentage-id="${a.id}"><span class="loader-small"></span></td>
                <td><div class="action-buttons">
                    <button class="delete-btn" data-type="administrator" data-id="${a.id}">Delete</button>
                </div></td>
            </tr>`).join('')}
        </tbody></table>`;
        listDiv.innerHTML = table;

        administratorsCache.forEach(async (admin) => {
            const percentage = await calculateAttendancePercentage(admin.id, 'administrator');
            const cell = listDiv.querySelector(`td[data-percentage-id="${admin.id}"]`);
            if (cell) {
                cell.textContent = percentage;
            }
        });
    }

    // --- Generic Camera Setup for Forms ---
    function setupGenericCamera(type) {
        const video = document.getElementById(`${type}-video`);
        const canvas = document.getElementById(`${type}-canvas`);
        if (!video || !canvas) return; // In case the elements don't exist
        const context = canvas.getContext('2d');
        const openCameraBtn = document.getElementById(`openCameraBtn${type.charAt(0).toUpperCase() + type.slice(1)}`);
        const imagePreview = document.getElementById(`${type}ImagePreview`);

        openCameraBtn.onclick = async () => {
            if (currentStream && currentStream.active) {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const imageDataURL = canvas.toDataURL('image/png');
                    imagePreview.src = imageDataURL;
                    imagePreview.style.display = 'block';
                    stopCamera(currentStream);
                    video.style.display = 'none';
                    openCameraBtn.textContent = 'Retake Image';
                    showAlert('Image captured!');
                } else {
                    showAlert('Camera is not ready yet. Please wait.');
                }
            } else {
                try {
                    const mediaStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    video.srcObject = mediaStream;
                    currentStream = mediaStream;
                    video.style.display = 'block';
                    openCameraBtn.textContent = 'Capture';
                } catch(err) {
                    showAlert('Camera access denied or not available.');
                }
            }
        };
    }
    
    // --- Generic Form Setup Logic with Face Detection ---
    async function setupAddFormListeners(type) {
        // Note: This function is now only for student and faculty, as admin signup is separate.
        setupGenericCamera(type);
        const form = document.getElementById(`add-${type}-form`);
        const saveBtn = document.getElementById(`save${type.charAt(0).toUpperCase() + type.slice(1)}Btn`);
        const imagePreview = document.getElementById(`${type}ImagePreview`);

        let isEditing = !!editingId;
        if (isEditing) {
            const data = (type === 'student' ? studentsCache : facultiesCache).find(item => item.id === editingId);
            if(data) {
                document.getElementById(`${type}Name`).value = data.name;
                if(type === 'student') {
                    document.getElementById('studentCollegeId').value = data.collegeId;
                    document.getElementById('studentClass').value = data.studentClass;
                } else {
                    document.getElementById('facultyDepartment').value = data.department;
                    document.getElementById('facultySubject').value = data.subject;
                }
                imagePreview.src = data.imageUrl;
                imagePreview.style.display = 'block';
            }
            saveBtn.textContent = `Update ${type}`;
            document.querySelector('h4').textContent = `Edit ${type}`;
        } else {
             document.querySelector('h4').textContent = `Add New ${type}`;
        }

        form.onsubmit = async (e) => {
            e.preventDefault();
            const imageUrl = imagePreview.src;
            if (!imageUrl || imageUrl.length < 100) {
                showAlert('Please capture an image before saving.'); return;
            }

            const detection = await faceapi.detectSingleFace(imagePreview, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
            if (!detection) {
                showAlert('No face was detected. Please retake the photo.'); return;
            }

            const descriptor = Array.from(detection.descriptor);
            let data = {};
            if (type === 'student') {
                data = {
                    name: document.getElementById('studentName').value, collegeId: document.getElementById('studentCollegeId').value,
                    studentClass: document.getElementById('studentClass').value, phone: document.getElementById('studentPhone').value,
                    parentPhone: document.getElementById('parentPhone').value, imageUrl, descriptor
                };
            } else { // faculty
                data = {
                    name: document.getElementById('facultyName').value, department: document.getElementById('facultyDepartment').value,
                    subject: document.getElementById('facultySubject').value, phone: document.getElementById('facultyPhone').value,
                    imageUrl, descriptor
                };
            }
            
            loadingOverlay.style.display = 'flex';
            loadingMessage.textContent = 'Saving data...';

            try {
                const collectionName = type === 'faculty' ? 'faculties' : `${type}s`;
                if (isEditing) {
                    const docRef = doc(db, collectionName, editingId);
                    await updateDoc(docRef, data);
                    showAlert(`${type} data updated successfully!`);
                } else {
                    await addDoc(collection(db, collectionName), data);
                    showAlert(`${type} data saved successfully!`);
                }
                updateMainContent(`${type}-data`);
            } catch (error) {
                showAlert(`Error saving data: ${error.message}`);
                console.error("Save error:", error);
            } finally {
                loadingOverlay.style.display = 'none';
            }
        };
    }
    
    // --- ATTENDANCE LOGIC ---
    async function renderAttendanceSheet(date, type, containerId) {
        const container = document.getElementById(containerId);
        if (!container) {
            console.error("Attendance container not found:", containerId);
            return;
        }
        container.innerHTML = `<div class="loader" style="margin: 40px auto;"></div>`;

        const database = type === 'student' ? studentsCache : (type === 'faculty' ? facultiesCache : administratorsCache);
        const collectionName = `${type}_attendance`;
        const idField = type === 'student' ? 'collegeId' : 'name';
        const secondaryField = type === 'student' ? 'collegeId' : (type === 'faculty' ? 'department' : 'role');
        const secondaryFieldHeader = type === 'student' ? 'College ID' : (type === 'faculty' ? 'Department' : 'Role');

        if (database.length === 0) {
            container.innerHTML = `<p>No ${type}s registered. Please add them first.</p>`;
            return;
        }

        const attendanceDocRef = doc(db, collectionName, date);
        const attendanceDoc = await getDoc(attendanceDocRef);
        const dailyRecords = attendanceDoc.exists() ? attendanceDoc.data().records || {} : {};

        const today = getFormattedDate(new Date());
        const isEditable = date === today;

        let tableHTML = `<h4>Showing Attendance for: ${date} ${!isEditable && !containerId.includes('-manual-') ? '(View Only)' : ''}</h4>
                                <table><thead><tr><th>S.No</th><th>Image</th><th>Name</th><th>${secondaryFieldHeader}</th><th>Status</th><th>Overall %</th></tr></thead><tbody>`;

        database.forEach((person, index) => {
            const status = dailyRecords[person.id] || 'Absent';
            const statusClass = status.toLowerCase();
            
            const statusElement = isEditable 
                ? `<button class="status-toggle ${statusClass}" data-date="${date}" data-personid="${person.id}" data-type="${type}">${status}</button>`
                : `<span class="status-toggle ${statusClass}" style="cursor: not-allowed;">${status}</span>`;

            tableHTML += `<tr>
                <td>${index + 1}</td>
                <td><img src="${person.imageUrl}" alt="${person.name}"></td>
                <td>${person.name}</td>
                <td>${person[secondaryField]}</td>
                <td>${statusElement}</td>
                <td data-percentage-id="${person.id}"><span class="loader-small"></span></td>
            </tr>`;
        });
        tableHTML += '</tbody></table>';
        container.innerHTML = tableHTML;

        database.forEach(async (person) => {
            const percentage = await calculateAttendancePercentage(person.id, type);
            const cell = container.querySelector(`td[data-percentage-id="${person.id}"]`);
            if (cell) {
                cell.textContent = percentage;
            }
        });
    }


    async function setupCombinedAttendanceCamera() {
        const video = document.getElementById('video-stream');
        const captureButton = document.getElementById('capture-image');
        const canvas = document.getElementById('photo-canvas');
        const messageDiv = document.getElementById('capture-message');
        const context = canvas.getContext('2d');
        
        try {
            if (!auth.currentUser || !auth.currentUser.isAnonymous) {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Anonymous sign-in failed.", error);
            if (messageDiv) {
                messageDiv.textContent = 'Error: Anonymous sign-in is not enabled in Firebase.';
                messageDiv.style.color = 'red';
            }
            showAlert('The attendance terminal could not start. Please go to your Firebase project -> Authentication -> Sign-in method and enable "Anonymous" sign-in.');
            return;
        }

        if (currentStream) stopCamera(currentStream);

        async function startCamera() {
            try {
                const mediaStream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = mediaStream;
                video.onloadedmetadata = () => { video.play(); };
                currentStream = mediaStream;
                video.style.display = 'block';
                captureButton.style.display = 'block';
                messageDiv.textContent = 'Camera is ready. Click Capture.';
                messageDiv.style.color = 'black';
            } catch (err) {
                messageDiv.textContent = 'Camera access denied or not available.';
                messageDiv.style.color = 'red';
            }
        }
        await startCamera();

        captureButton.onclick = async () => {
            if (video.readyState !== video.HAVE_ENOUGH_DATA) {
                showAlert('Camera is not ready.'); return;
            }
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            stopCamera(currentStream);
            video.style.display = 'none';
            captureButton.style.display = 'none';
            messageDiv.textContent = 'Image captured! Matching...';
            
            const type = document.querySelector('input[name="attendanceType"]:checked').value;
            const collectionName = type === 'faculty' ? 'faculties' : `${type}s`;
            const idField = type === 'student' ? 'collegeId' : 'name';
            
            const querySnapshot = await getDocs(collection(db, collectionName));
            const database = querySnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
            
            if (database.length === 0) {
                 messageDiv.textContent = `No ${type}s registered.`;
                 messageDiv.style.color = 'red';
                 setTimeout(startCamera, 2000); return;
            }

            const labeledDescriptors = database
                .filter(p => p.descriptor)
                .map(p => new faceapi.LabeledFaceDescriptors(p[idField], [new Float32Array(p.descriptor)]));
            
            if (labeledDescriptors.length === 0) {
                messageDiv.textContent = `No ${type}s have a registered face.`;
                messageDiv.style.color = 'red';
                setTimeout(startCamera, 2000); return;
            }
            
            const faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.45);
            const detection = await faceapi.detectSingleFace(canvas, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
            
            if (detection) {
                const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
                if (bestMatch.label !== 'unknown') {
                    const personIdValue = bestMatch.label;
                    const person = database.find(p => p[idField] === personIdValue);
                    if (person) {
                        const today = getFormattedDate(new Date());
                        const attendanceCollectionName = `${type}_attendance`;
                        const docRef = doc(db, attendanceCollectionName, today);
                        
                        const attendanceDoc = await getDoc(docRef);
                        const dailyRecords = attendanceDoc.exists() ? attendanceDoc.data().records || {} : {};

                        if (dailyRecords[person.id] === 'Present') {
                            messageDiv.textContent = `Attendance already marked for ${person.name}.`;
                            messageDiv.style.color = '#ffc107'; // A nice yellow/orange for warning
                        } else {
                            await setDoc(docRef, {
                                records: { [person.id]: 'Present' }
                            }, { merge: true });

                            const confidence = ((1 - bestMatch.distance) * 100).toFixed(2);
                            messageDiv.textContent = `Attendance marked for ${person.name}! (Confidence: ${confidence}%)`;
                            messageDiv.style.color = 'green';
                        }
                    }
                } else {
                    messageDiv.textContent = `Face detected, but no match found.`;
                    messageDiv.style.color = 'red';
                }
            } else {
                messageDiv.textContent = 'No face detected in the image.';
                messageDiv.style.color = 'red';
            }
            setTimeout(startCamera, 3000);
        };
    }

    // --- Content Update and Event Handling ---
    function updateMainContent(contentId) {
        stopCamera(currentStream);
        contentBox.innerHTML = mainContent[contentId];
        editingId = null; editingType = '';

        if (contentId === 'student-data') {
            renderStudents();
        } else if (contentId === 'faculty-data') {
            renderFaculties();
        } else if (contentId === 'administrator') {
            renderAdministrators();
            const datePicker = document.getElementById('administrator-attendance-date');
            if (datePicker) datePicker.value = getFormattedDate(new Date());
        } else if (contentId === 'face-attendance') {
            setupCombinedAttendanceCamera();
        } else if (contentId.includes('-attendance')) {
            const type = contentId.split('-')[0];
            const datePicker = document.getElementById(`${type}-attendance-date`);
            if (datePicker) datePicker.value = getFormattedDate(new Date());
        }
    }

    function updateSubContent(contentId) {
        stopCamera(currentStream);
        contentBox.innerHTML = subContent[contentId];
        const today = getFormattedDate(new Date());
        if (contentId === 'add-student') {
            setupAddFormListeners('student');
        } else if (contentId === 'add-faculty') {
            setupAddFormListeners('faculty');
        } else if (contentId === 'mark-student-attendance-manual') {
            renderAttendanceSheet(today, 'student', 'student-manual-attendance-sheet');
        } else if (contentId === 'mark-faculty-attendance-manual') {
            renderAttendanceSheet(today, 'faculty', 'faculty-manual-attendance-sheet');
        } else if (contentId === 'mark-administrator-attendance-manual') {
            renderAttendanceSheet(today, 'administrator', 'administrator-manual-attendance-sheet');
        }
    }
    
    contentBox.addEventListener('click', async (event) => {
        const target = event.target;
        if (target.classList.contains('sub-option')) {
            updateSubContent(target.getAttribute('data-sub-content'));
        } else if (target.classList.contains('back-button')) {
            updateMainContent(target.getAttribute('data-back-to'));
        } else if (target.id === 'view-student-attendance-btn' || target.id === 'view-faculty-attendance-btn' || target.id === 'view-administrator-attendance-btn') {
            const type = target.id.split('-')[1];
            const date = document.getElementById(`${type}-attendance-date`).value;
            if (!date) { showAlert('Please select a date.'); return; }
            renderAttendanceSheet(date, type, `${type}-attendance-sheet-container`);
        } else if (target.classList.contains('status-toggle') && target.tagName === 'BUTTON') {
            const date = target.dataset.date;
            const personId = target.dataset.personid;
            const type = target.dataset.type;
            const attendanceCollectionName = `${type}_attendance`;
            const docRef = doc(db, attendanceCollectionName, date);
            const currentStatus = target.textContent;
            const newStatus = currentStatus === 'Present' ? 'Absent' : 'Present';
            try {
                await setDoc(docRef, { records: { [personId]: newStatus } }, { merge: true });
                target.textContent = newStatus;
                target.className = `status-toggle ${newStatus.toLowerCase()}`;
            } catch (error) {
                showAlert('Failed to update status.');
                console.error("Status update error:", error);
            }
        } else if (target.classList.contains('delete-btn')) {
            const id = target.getAttribute('data-id');
            const dataType = target.getAttribute('data-type');
            
            const user = auth.currentUser;
            if (!user || user.isAnonymous) {
                showAlert('You must be logged in as an administrator to perform this action.');
                return;
            }

            const password = await showPasswordConfirm(`To delete this ${dataType}, please enter your administrator password:`);

            if (password === null) {
                return; 
            }

            if (!password) {
                showAlert('Password is required for deletion.');
                return;
            }

            loadingOverlay.style.display = 'flex';
            loadingMessage.textContent = 'Verifying and deleting...';

            try {
                const credential = EmailAuthProvider.credential(user.email, password);
                await reauthenticateWithCredential(user, credential);
                
                const collectionName = dataType === 'faculty' ? 'faculties' : `${dataType}s`;
                await deleteDoc(doc(db, collectionName, id));
                showAlert(`${dataType} deleted successfully.`);

            } catch (error) {
                if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                     showAlert('Incorrect password. Deletion cancelled.');
                } else {
                     showAlert(`An error occurred: ${error.message}`);
                }
                console.error("Re-authentication or deletion error:", error);
            } finally {
                loadingOverlay.style.display = 'none';
            }
        } else if (target.classList.contains('edit-btn')) {
            editingId = target.getAttribute('data-id');
            editingType = target.getAttribute('data-type');
            updateSubContent(`add-${editingType}`);
        }
    });

    // --- Menu Item Click Handling ---
    menuItems.forEach(item => {
        item.addEventListener('click', async () => {
            const contentId = item.getAttribute('data-content-id');
            const isFaceAttendanceTab = contentId === 'face-attendance';
            
            menuItems.forEach(i => i.classList.remove('active'));
            item.classList.add('active');

            // If a user is already logged in as an admin, sign them out before proceeding.
            // This enforces re-authentication for every protected tab click.
            if (auth.currentUser && !auth.currentUser.isAnonymous) {
                await signOut(auth);
            }

            if (isFaceAttendanceTab) {
                // Always allow free access to the face attendance kiosk.
                updateMainContent(contentId);
            } else {
                // For any other tab, always prompt for login.
                renderLogin(contentId);
            }
        });
    });

    // The initial rendering logic is now handled by the onAuthStateChanged listener to prevent race conditions.

});


</script>

</body>
</html>
